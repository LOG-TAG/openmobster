<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory">Chapter 13. PhoneGap: Offline Web Apps using the Sync Plugin</title><link rel="stylesheet" href="css/seamframework.css" type="text/css"/><meta xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" name="generator" content="DocBook XSL Stylesheets V1.74.0"/><link rel="home" href="index.html" title="OpenMobster - Mobile Cloud Platform"/><link rel="up" href="index.html" title="OpenMobster - Mobile Cloud Platform"/><link rel="prev" href="d2d.html" title="Chapter 12. Device-To-Device Push Framework"/><link rel="next" href="pg_ios.html" title="Chapter 14. PhoneGap + iOS + OpenMobster integration"/></head><body><p id="title"><a href="http://www.seamframework.org" class="site_href"><strong>SeamFramework.org</strong></a><a href="http://www.seamframework.org/Documentation" class="doc_href"><strong>Community Documentation</strong></a></p><ul class="docnav"><li class="previous"><a accesskey="p" href="d2d.html"><strong>Prev</strong></a></li><li class="next"><a accesskey="n" href="pg_ios.html"><strong>Next</strong></a></li></ul><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="pg_sample"/>Chapter 13. PhoneGap: Offline Web Apps using the Sync Plugin</h2></div><div><div class="author"><h3 class="author"><span class="firstname">openmobster</span> <span class="surname">at gmail.com</span></h3><code class="email">&lt;<a class="email" href="mailto:openmobster@gmail.com">openmobster@gmail.com</a>&gt;</code></div></div></div></div><div class="toc"><dl><dt><span class="sect1"><a href="pg_sample.html#d0e1843">13.1. Introduction</a></span></dt><dt><span class="sect1"><a href="pg_sample.html#d0e1860">13.2. Offline App Usage</a></span></dt><dd><dl><dt><span class="sect2"><a href="pg_sample.html#d0e1863">13.2.1. Running the Cloud Server</a></span></dt><dt><span class="sect2"><a href="pg_sample.html#d0e1871">13.2.2. Cloud Activation</a></span></dt><dt><span class="sect2"><a href="pg_sample.html#d0e1887">13.2.3. Installing the Offline App</a></span></dt></dl></dd><dt><span class="sect1"><a href="pg_sample.html#d0e1895">13.3. Dissecting the JQuery Offline App</a></span></dt><dd><dl><dt><span class="sect2"><a href="pg_sample.html#d0e1898">13.3.1. Load Synchronized Beans</a></span></dt><dt><span class="sect2"><a href="pg_sample.html#d0e1931">13.3.2. Add a New Bean to the Sync Channel</a></span></dt><dt><span class="sect2"><a href="pg_sample.html#d0e1969">13.3.3. Update an existing Bean in the Sync Channel</a></span></dt><dt><span class="sect2"><a href="pg_sample.html#d0e1977">13.3.4. Delete a Bean from the Sync Channel</a></span></dt></dl></dd><dt><span class="sect1"><a href="pg_sample.html#d0e1991">13.4. Dissecting the Cloud</a></span></dt><dd><dl><dt><span class="sect2"><a href="pg_sample.html#d0e1994">13.4.1. The MobileBean</a></span></dt><dt><span class="sect2"><a href="pg_sample.html#d0e2016">13.4.2. The Channel</a></span></dt></dl></dd></dl></div><div class="sect1" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e1843"/>13.1. Introduction</h2></div></div></div><p>
   		 	<a class="ulink" href="http://www.phonegap.com">PhoneGap</a> is an HTML5 app platform that allows you to author native applications with web technologies and get access to APIs and app stores. <span class="bold"><strong>PhoneGap</strong></span> leverages web technologies developers already know best... HTML and JavaScript.
   		 	Starting with <span class="bold"><strong>OpenMobster 2.2-M8</strong></span>, you can write offline web apps with synchronization of data using the <span class="bold"><strong>OpenMobster Sync Plugin</strong></span> for PhoneGap. The Sync Plugin exposes the native Sync service to the
   		 	JavaScript layer using the PhoneGap bridge technology. The rest of this chapter will discuss how to use the Sync Plugin using a JQuery based sample offline application.
   		</p></div><div class="sect1" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e1860"/>13.2. Offline App Usage</h2></div></div></div><div class="sect2" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1863"/>13.2.1. Running the Cloud Server</h3></div></div></div><p>
   			</p><pre class="programlisting">
   				
   					cd PhoneGap/plugin-jquery-cloud
   					
   					mvn -PrunCloud integration-test
   				
   			</pre><p>
   			This should make the OpenMobster Cloud Server up and running for the Offline App.
   			</p></div><div class="sect2" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1871"/>13.2.2. Cloud Activation</h3></div></div></div><p>
   			For security reasons, before apps can use the OpenMobster Cloud, the device must be registered with the cloud. 
   			This is done using a CloudManager App that comes with the OpenMobster distribution. 
   			</p><p>
   			You can locate this App in the distribution under <span class="bold"><strong>Android/core-runtime/CloudManager.apk</strong></span>.
   			You can install this App on the Android device or emulator using the following command:
   			</p><pre class="programlisting">
   				
   					adb install -r CloudManager.apk
   				
   			</pre><p>
   			Once installed you can use the <span class="bold"><strong>Activate</strong></span> function to register with the Cloud.
   			</p></div><div class="sect2" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1887"/>13.2.3. Installing the Offline App</h3></div></div></div><p>
   			</p><pre class="programlisting">
   				
   					adb install -r JQueryOfflineApp.apk
   				
   			</pre><p>
   			</p></div></div><div class="sect1" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e1895"/>13.3. Dissecting the JQuery Offline App</h2></div></div></div><div class="sect2" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1898"/>13.3.1. Load Synchronized Beans</h3></div></div></div><p>
   				</p><pre class="programlisting">
   					
   					//read the oids of the tickets stored in the sync channel
	  		window.plugins.sync.readall(channel,
				function(oids)
				{
					if(oids == '0')
					{
						return;
					}
					
					oids = JSON.parse(oids);
					var length = oids.length;
					for(var i=0; i&lt;length; i++)
					{
					   var oid = oids[i];
					   
					   //read the value of the 'title' property of the synchronized bean
					   window.plugins.sync.value(channel,oid,'title',
						   function(value)
						   {
						   		var encodedOid = encodeURIComponent(oid);
		   		
		   						//create a list item corresponding to the ticket in question
		   						html += '&lt;li&gt;&lt;a href="#read_ticket?oid='+encodedOid+'" data-rel="dialog"&gt;'+value+'&lt;/a&gt;&lt;/li&gt;';
						   },
						   function(error)
						   {
						   }
					   );
					}
				},
				function(error)
				{
					alert('Sync Plugin:'+error);
				}
			);
   					
   				</pre><p>
   				This function reads the oids of the beans and then iterates through each bean and extracts the <span class="bold"><strong>title</strong></span> property.
   			</p><p>
   				</p><pre class="programlisting">
   					
   				window.plugins.sync.readall(channel,
				function(oids)
				{
					if(oids == '0')
					{
						return;
					}
					
					oids = JSON.parse(oids);
   					
   				</pre><p>
   				Invokes the <span class="bold"><strong>readall</strong></span> function and reads the oids of all the beans stored in the sync channel. 
   				If the function is successful it returns an array of oids in JSON format. oids are then parse into a JavaScript object using
   				the <span class="bold"><strong>JSON.parse</strong></span> function.
   			</p><p>
   				</p><pre class="programlisting">
   					
   						//read the value of the 'title' property of the synchronized bean
					   window.plugins.sync.value(channel,oid,'title',
						   function(value)
						   {
						   		var encodedOid = encodeURIComponent(oid);
		   		
		   						//create a list item corresponding to the ticket in question
		   						html += '&lt;li&gt;&lt;a href="#read_ticket?oid='+encodedOid+'" data-rel="dialog"&gt;'+value+'&lt;/a&gt;&lt;/li&gt;';
						   },
						   function(error)
						   {
						   }
					   );
					   
   				</pre><p>
   				<span class="bold"><strong>window.plugins.sync.value</strong></span> reads the value of the specified <span class="bold"><strong>title</strong></span> property.
   				It takes the channel name and the oid of the bean as arguments to locate the bean whose property is to be read.
   			</p></div><div class="sect2" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1931"/>13.3.2. Add a New Bean to the Sync Channel</h3></div></div></div><p>
   				</p><pre class="programlisting">
   					
   					window.plugins.sync.addNewBean(channel,
					function(tempoid)
					{
						window.plugins.sync.updateBean(channel,tempoid,'title',title,
						function(success)
						{
						},
						function(error)
						{
						});
						
						window.plugins.sync.updateBean(channel,tempoid,'customer',customer,
						function(success)
						{
						},
						function(error)
						{
						});
						
						window.plugins.sync.updateBean(channel,tempoid,'specialist',specialist,
						function(success)
						{
						},
						function(error)
						{
						});
						
						window.plugins.sync.updateBean(channel,tempoid,'comments',comments,
						function(success)
						{
						},
						function(error)
						{
						});
					},
					function(error)
					{
						alert("Sync Plugin:"+error);
					});
					
					//Commit here
					window.plugins.sync.commit(function(success)
					{
						alert("Ticket was successfully added");
					},
					function(error){
						alert("Ticket Add Error:"+error);
					});
   					
   				</pre><p>
   				The above code creates a new bean in the Sync Channel. Once the bean is created, its properties are updated and committed to the Sync Engine for synchronization
   			</p><p>
   				</p><pre class="programlisting">
   				
   					window.plugins.sync.addNewBean(channel,
					function(tempoid)
					{
   				
   				</pre><p>
   				<span class="bold"><strong>window.plugins.sync.addNewBean</strong></span> creates a new bean into the Sync Channel. The method returns a temporary oid used to refer to this newly added bean.
   			</p><p>
   				</p><pre class="programlisting">
   					
   						window.plugins.sync.updateBean(channel,tempoid,'title',title,
						function(success)
						{
						},
						function(error)
						{
						});
						
						window.plugins.sync.updateBean(channel,tempoid,'customer',customer,
						function(success)
						{
						},
						function(error)
						{
						});
   					
   				</pre><p>
   				<span class="bold"><strong>window.plugins.sync.updateBean</strong></span> updates the specified property on the bean referred to by its oid.
   				In this case it modifies the <span class="bold"><strong>title</strong></span> property on the newly added bean referred to by <span class="bold"><strong>tempoid</strong></span>.
   			</p><p>
   				</p><pre class="programlisting">
   					
   					//Commit here
					window.plugins.sync.commit(function(success)
					{
						alert("Ticket was successfully added");
					},
					function(error){
						alert("Ticket Add Error:"+error);
					});
   					
   				</pre><p>
   				<span class="bold"><strong>window.plugins.sync.commit</strong></span> commits the beans into the Sync Channel for synchronization
   			</p></div><div class="sect2" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1969"/>13.3.3. Update an existing Bean in the Sync Channel</h3></div></div></div><p>
   				</p><pre class="programlisting">
   					
   					var oid = $('#update_ticket_oid').val();
					
					//update the 'title' property on the ticket bean
					window.plugins.sync.updateBean(channel,oid,'title',title,
					function(success)
					{
						
					},
					function(error)
					{
					});
					
					//update the 'customer' property on the ticket bean
					window.plugins.sync.updateBean(channel,oid,'customer',customer,
					function(success)
					{
						
					},
					function(error)
					{
					});
					
					//update the 'specialist' property on the ticket bean
					window.plugins.sync.updateBean(channel,oid,'specialist',specialist,
					function(success)
					{
						
					},
					function(error)
					{
					});
					
					//update the 'comments' property on the ticket bean
					window.plugins.sync.updateBean(channel,oid,'comments',comments,
					function(success)
					{
						
					},
					function(error)
					{
					});
					
					//commit
				    window.plugins.sync.commit(function(success)
					{
						alert("The Ticket was successfully saved");
					},
					function(error){
						alert('Ticket Update Failed: '+error);
					});
   					
   				</pre><p>
   				This is very similar to the add new bean explanation above. It updates each property of the bean and then calls commit to get the bean synchronized with the Cloud.
   			</p></div><div class="sect2" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1977"/>13.3.4. Delete a Bean from the Sync Channel</h3></div></div></div><p>
   				</p><pre class="programlisting">
   					
   				function deleteTicket()
				{
					var oid = $('#read_ticket_oid').val();
					
					//delete this bean
					window.plugins.sync.deleteBean(channel,oid,
						function(success)
						{
							//commit
						    window.plugins.sync.commit(function(success)
							{
								alert("The Ticket was successfully deleted");
							},
							function(error){alert("Ticket Delete Failed: "+error);});
						},
						function(error)
						{
							alert("Ticket Delete Failed: "+error);
						}
					);
					$.mobile.changePage('#tickets','slide',true,false);
				}
   					
   				</pre><p>
   				<span class="bold"><strong>window.plugins.sync.deleteBean</strong></span> deletes the bean referred to by the oid on the specified channel.
   				<span class="bold"><strong>window.plugins.sync.commit</strong></span> commits this change into the Sync Channel and prepares for synchronization with the Cloud.
   			</p></div></div><div class="sect1" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e1991"/>13.4. Dissecting the Cloud</h2></div></div></div><div class="sect2" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e1994"/>13.4.1. The MobileBean</h3></div></div></div><p>
   				</p><pre class="programlisting">
   					
   					public class JQueryBean implements MobileBean,Serializable
					{
						@MobileBeanId
						private String oid;
   					
   				</pre><p>
   				Creates a <span class="bold"><strong>MobileBean</strong></span> by implementing the MobileBean interface. This is the component
   				which will be injected into the Sync Channel. It will then be accesssed on the device via the Sync Plugin API.
   				The <span class="bold"><strong>MobileBeanId</strong></span> annotation specified that the <span class="bold"><strong>oid</strong></span> field
   				will serve as the unique object identifier for these beans.
   			</p><p>
   				Full Source of the MobileBean implementation
   				</p><pre class="programlisting">
   					
public class JQueryBean implements MobileBean,Serializable
{
	@MobileBeanId
	private String oid;
	
	private String title;
	private String customer;
	private String specialist;
	private String comments;
	
	public JQueryBean()
	{
		
	}

	public String getOid()
	{
		return oid;
	}

	public void setOid(String oid)
	{
		this.oid = oid;
	}

	public String getTitle()
	{
		return title;
	}

	public void setTitle(String title)
	{
		this.title = title;
	}

	public String getCustomer()
	{
		return customer;
	}

	public void setCustomer(String customer)
	{
		this.customer = customer;
	}

	public String getSpecialist()
	{
		return specialist;
	}

	public void setSpecialist(String specialist)
	{
		this.specialist = specialist;
	}

	public String getComments()
	{
		return comments;
	}

	public void setComments(String comments)
	{
		this.comments = comments;
	}
}
   					
   				</pre><p>
   			</p></div><div class="sect2" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e2016"/>13.4.2. The Channel</h3></div></div></div><p>
   				<span class="bold"><strong>The Channel</strong></span> is the component that exposes the <span class="bold"><strong>MobileBeans</strong></span>
   				to the Sync Engine via a CRUD (Create, Read, Update, Delete) interface.
   				
   				</p><pre class="programlisting">
   					
@ChannelInfo(uri="plugin_jquery_channel", mobileBeanClass="org.openmobster.core.phonegap.plugin.jquery.cloud.JQueryBean")
public class PluginJQueryChannel implements Channel
   					
   				</pre><p>
   				The <span class="bold"><strong>ChannelInfo.uri</strong></span> specifies the name of the Sync Channel and <span class="bold"><strong>ChannelInfo.mobileBeanClass</strong></span>
   				specifies the class of the MobileBean instance that the channel will be dealing with. The MobileBean instances used by the Channel implementation must be
   				instances of this specified class. If this rule is not followed there will be unexpected errors during the synchronization process.
   			</p><div class="sect3" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e2036"/>13.4.2.1. Read the MobileBeans</h4></div></div></div><p>
   					</p><pre class="programlisting">
   						
@Override
	public List&lt;? extends MobileBean&gt; readAll() 
	{
		Collection&lt;Object&gt; all = this.objectStore.readAll();
		List&lt;JQueryBean&gt; beans = new ArrayList&lt;JQueryBean&gt;();
		if(all != null &amp;&amp; !all.isEmpty())
		{
			for(Object bean:all)
			{
				beans.add((JQueryBean)bean);
			}
		}
		
		return beans;
	}

	@Override
	public List&lt;? extends MobileBean&gt; bootup() 
	{
		return this.readAll();
	}
	
	@Override
	public MobileBean read(String id) 
	{
		return (JQueryBean)this.objectStore.read(id);
	} 						
   						
   					</pre><p>
   				</p></div><div class="sect3" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e2044"/>13.4.2.2. Create the MobileBean</h4></div></div></div><p>
   					</p><pre class="programlisting">
   						
   	@Override
	public String create(MobileBean mobileBean) 
	{
		JQueryBean toCreate = (JQueryBean)mobileBean;
		return this.objectStore.save(toCreate.getOid(), toCreate);
	}
   						
   					</pre><p>
   				</p></div><div class="sect3" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e2052"/>13.4.2.3. Update the MobileBean</h4></div></div></div><p>
   					</p><pre class="programlisting">
   						
   	@Override
	public void update(MobileBean mobileBean) 
	{
		JQueryBean toUpdate = (JQueryBean)mobileBean;
		this.objectStore.save(toUpdate.getOid(), toUpdate);
	}
   						
   					</pre><p>
   				</p></div><div class="sect3" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e2060"/>13.4.2.4. Delete the MobileBean</h4></div></div></div><p>
   					</p><pre class="programlisting">
   						
   	@Override
	public void delete(MobileBean mobileBean) 
	{	
		JQueryBean toDelete = (JQueryBean)mobileBean;
		this.objectStore.delete(toDelete.getOid());
	}
   						
   					</pre><p>
   				</p></div></div></div></div><ul class="docnav"><li class="previous"><a accesskey="p" href="d2d.html"><strong>Prev</strong>Chapter 12. Device-To-Device Push Framework</a></li><li class="up"><a accesskey="u" href="#"><strong>Top of page</strong></a></li><li class="home"><a accesskey="h" href="index.html"><strong>Front page</strong></a></li><li class="next"><a accesskey="n" href="pg_ios.html"><strong>Next</strong>Chapter 14. PhoneGap + iOS + OpenMobster integrat...</a></li></ul></body></html>