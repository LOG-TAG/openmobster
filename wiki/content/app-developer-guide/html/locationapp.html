<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory">Chapter 15. Location Aware Apps</title><link rel="stylesheet" href="css/seamframework.css" type="text/css"/><meta xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" name="generator" content="DocBook XSL Stylesheets V1.74.0"/><link rel="home" href="index.html" title="OpenMobster - Mobile Cloud Platform"/><link rel="up" href="index.html" title="OpenMobster - Mobile Cloud Platform"/><link rel="prev" href="pg_reference.html" title="Chapter 14. PhoneGap: Sync Plugin Reference"/><link rel="next" href="mobilerpc.html" title="Chapter 16. Mobile RPC (Remote Procedure Call) Development"/></head><body><p id="title"><a href="http://www.seamframework.org" class="site_href"><strong>SeamFramework.org</strong></a><a href="http://www.seamframework.org/Documentation" class="doc_href"><strong>Community Documentation</strong></a></p><ul class="docnav"><li class="previous"><a accesskey="p" href="pg_reference.html"><strong>Prev</strong></a></li><li class="next"><a accesskey="n" href="mobilerpc.html"><strong>Next</strong></a></li></ul><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="locationapp"/>Chapter 15. Location Aware Apps</h2></div><div><div class="author"><h3 class="author"><span class="firstname">openmobster</span> <span class="surname">at gmail.com</span></h3><code class="email">&lt;<a class="email" href="mailto:openmobster@gmail.com">openmobster@gmail.com</a>&gt;</code></div></div></div></div><div class="toc"><dl><dt><span class="sect1"><a href="locationapp.html#d0e2709">15.1. Location Aware Apps</a></span></dt><dt><span class="sect1"><a href="locationapp.html#d0e2725">15.2. LocationServiceBean</a></span></dt><dt><span class="sect1"><a href="locationapp.html#d0e2764">15.3. The App Side Logic</a></span></dt><dd><dl><dt><span class="sect2"><a href="locationapp.html#d0e2818">15.3.1. Processing the Response</a></span></dt></dl></dd></dl></div><div class="sect1" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e2709"/>15.1. Location Aware Apps</h2></div></div></div><p>
			This tutorial covers developing <span class="bold"><strong>Location Aware Apps</strong></span> using the new <span class="bold"><strong>Location Module</strong></span> of the OpenMobster platform. <span class="bold"><strong>Location Awareness</strong></span> means writing your business logic by taking Location information into account.
   		 </p><p>
   		 	In OpenMobster, the business components are encapsulated with this Location information. The components then have easy access to the Location data and can easily integrate it with the business data. 
   		 </p></div><div class="sect1" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e2725"/>15.2. LocationServiceBean</h2></div></div></div><p>
   		On the Cloud-side, <span class="bold"><strong>LocationServiceBean</strong></span> components are encapsulated by Location Data carried inside an object called the <span class="bold"><strong>LocationContext</strong></span>. Invocation of these components involves two paramaters. One is the <span class="bold"><strong>LocationContext</strong></span> and the other is a <span class="bold"><strong>Request</strong></span> object which carries the business data associated with the invocation. The following is a <span class="bold"><strong>RestaurantBean</strong></span> which provides coupon data associated with restaurants that are close to a certain user provided location.
   		</p><p>
   			</p><pre class="programlisting">
   			
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Random;

import org.openmobster.cloud.api.location.LocationContext;
import org.openmobster.cloud.api.location.LocationServiceBean;
import org.openmobster.cloud.api.location.BeanURI;
import org.openmobster.cloud.api.location.Request;
import org.openmobster.cloud.api.location.Response;
import org.openmobster.cloud.api.location.Place;

/**
 *
 * @author openmobster@gmail.com
 */
@BeanURI(uri="restaurants")
public class RestaurantBean implements LocationServiceBean
   			
   			</pre><p>
   			<span class="bold"><strong>BeanURI</strong></span> registers this component with the kernel.
   		</p><p>
   			</p><pre class="programlisting">
   			
   			@Override
	public Response invoke(LocationContext locationContext, Request request)
	{
		Response response = new Response();
		
		//Get coupons associated with each place
		List&lt;Place&gt; nearbyPlaces = locationContext.getNearbyPlaces();
		if(nearbyPlaces != null &amp;&amp; !nearbyPlaces.isEmpty())
		{
			Map&lt;String,String&gt; coupons = new HashMap&lt;String,String&gt;();
			for(Place place:nearbyPlaces)
			{
				String placeId = place.getId();
				
				//In a real implementation, you can lookup the coupon in the database based on the Place object
				int couponIndex = (this.random.nextInt())%7;
				couponIndex = Math.abs(couponIndex);
				String coupon = coupondb[couponIndex];
				
				coupons.put(placeId, coupon);
			}
			response.setMapAttribute("coupons", coupons);
		}
		
		return response;
	}
   			
   			</pre><p>
   			It takes a list of nearby restaurants from the <span class="bold"><strong>LocationContext</strong></span> and then associates coupons from a database with each. This business data married with location data is then sent back as a <span class="bold"><strong>Response</strong></span> object.
   		</p></div><div class="sect1" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e2764"/>15.3. The App Side Logic</h2></div></div></div><p>
		In this app, the location data is provided by the user in terms of street, city, and zip code. Once this data is available, an invocation is made from the device to the cloud to get nearby restaurants to this location.
		</p><p>
		</p><pre class="programlisting">
		
		String street = (String)commandContext.getAttribute("street");
			String city = (String)commandContext.getAttribute("city");
			String zip = (String)commandContext.getAttribute("zip");
			
			//Construct a request for the RestaurantBean
			Request request = new Request("restaurants");
			LocationContext locationContext = new LocationContext();
			locationContext.setRequest(request);
			
			//Add the Address around which the restaurants must be looked up
			Address address = new Address();
			address.setStreet(street);
			address.setCity(city);
			address.setZipCode(zip);
			locationContext.setAddress(address);
			
			//Narrow search to restaurants
			List&lt;String&gt; placeTypes = new ArrayList&lt;String&gt;();
			placeTypes.add("food");
			locationContext.setPlaceTypes(placeTypes);
			
			//Set the search radius
			locationContext.setRadius(1000); //1000 meters
			
			//Make the invocation to the Cloud to make a Location Aware search
			LocationContext responseContext = LocationService.invoke(request, locationContext);
			
			commandContext.setAttribute("locationContext", responseContext);
		
		</pre><p>
		</p><p>
			</p><pre class="programlisting">
			
			//Construct a request for the RestaurantBean
                        Request request = new Request("restaurants");
                        LocationContext locationContext = new LocationContext();
                        locationContext.setRequest(request);
			
			</pre><p>
			A <span class="bold"><strong>Request</strong></span> object is created and its given the name of the component to invoke which is <span class="bold"><strong>restaurants</strong></span> in this case. A <span class="bold"><strong>LocationContext</strong></span> is also initialized which will carry the location data associated with the invocation
		</p><p>
			</p><pre class="programlisting">
			
			//Add the Address around which the restaurants must be looked up
        Address address = new Address();
        address.setStreet(street);
        address.setCity(city);
        address.setZipCode(zip);
        locationContext.setAddress(address);
			
			</pre><p>
			Create an <span class="bold"><strong>Address</strong></span> object and assign it to the <span class="bold"><strong>LocationContext</strong></span>.
		</p><p>
			</p><pre class="programlisting">
			
						//Narrow search to restaurants
                        List&lt;String&gt; placeTypes = new ArrayList&lt;String&gt;();
                        placeTypes.add("food");
                        locationContext.setPlaceTypes(placeTypes);

						//Set the search radius
                        locationContext.setRadius(1000); //1000 meters
			
			</pre><p>
			Narrow the search to only restaurants over a 1000 meter search radius.
		</p><p>
			</p><pre class="programlisting">
			
			//Make the invocation to the Cloud to make a Location Aware search
                        LocationContext responseContext = LocationService.invoke(request, locationContext);
			
			</pre><p>
			Invoke the <span class="bold"><strong>RestaurantBean</strong></span> providing the location data in the <span class="bold"><strong>LocationContext</strong></span> and business data inside the <span class="bold"><strong>Request</strong></span> object.
		</p><div class="sect2" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e2818"/>15.3.1. Processing the Response</h3></div></div></div><p>
				</p><pre class="programlisting">
				
				Map&lt;String,String&gt; coupons = response.getMapAttribute("coupons");
			List&lt;Place&gt; restaurants = locationContext.getNearbyPlaces();
			
			//Add restaurant markers and corresponding coupon information
			MyItemizedOverlay restaurantMarkers = new MyItemizedOverlay(marker,map);
			for(Place restaurant:restaurants)
			{
				double latitude = Double.parseDouble(restaurant.getLatitude());
				double longitude = Double.parseDouble(restaurant.getLongitude());
				GeoPoint point = new GeoPoint((int)(latitude * 1E6), (int)(longitude * 1E6));
				OverlayItem item = new OverlayItem(point,restaurant.getName(),coupons.get(restaurant.getId()));
				restaurantMarkers.addOverlay(item);
			}
				
				</pre><p>
				The coupons being business data are read from the <span class="bold"><strong>Response</strong></span> object as a <span class="bold"><strong>Map&lt;String,String&gt;</strong></span>, while the nearby restaurants
				being location data are read from the <span class="bold"><strong>LocationContext</strong></span>.
			</p></div></div></div><ul class="docnav"><li class="previous"><a accesskey="p" href="pg_reference.html"><strong>Prev</strong>Chapter 14. PhoneGap: Sync Plugin Reference</a></li><li class="up"><a accesskey="u" href="#"><strong>Top of page</strong></a></li><li class="home"><a accesskey="h" href="index.html"><strong>Front page</strong></a></li><li class="next"><a accesskey="n" href="mobilerpc.html"><strong>Next</strong>Chapter 16. Mobile RPC (Remote Procedure Call) De...</a></li></ul></body></html>