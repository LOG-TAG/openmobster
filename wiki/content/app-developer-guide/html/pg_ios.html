<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><title xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory">Chapter 13. PhoneGap + iOS + OpenMobster integration</title><link rel="stylesheet" href="css/seamframework.css" type="text/css"/><meta xmlns:rf="java:org.jboss.highlight.XhtmlRendererFactory" name="generator" content="DocBook XSL Stylesheets V1.74.0"/><link rel="home" href="index.html" title="OpenMobster - Mobile Cloud Platform"/><link rel="up" href="index.html" title="OpenMobster - Mobile Cloud Platform"/><link rel="prev" href="pg_sample.html" title="Chapter 12. PhoneGap: Offline Web Apps using the Sync Plugin"/><link rel="next" href="pg_reference.html" title="Chapter 14. PhoneGap: Sync Plugin Reference"/></head><body><p id="title"><a href="http://www.seamframework.org" class="site_href"><strong>SeamFramework.org</strong></a><a href="http://www.seamframework.org/Documentation" class="doc_href"><strong>Community Documentation</strong></a></p><ul class="docnav"><li class="previous"><a accesskey="p" href="pg_sample.html"><strong>Prev</strong></a></li><li class="next"><a accesskey="n" href="pg_reference.html"><strong>Next</strong></a></li></ul><div class="chapter" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="pg_ios"/>Chapter 13. PhoneGap + iOS + OpenMobster integration</h2></div><div><div class="author"><h3 class="author"><span class="firstname">openmobster</span> <span class="surname">at gmail.com</span></h3><code class="email">&lt;<a class="email" href="mailto:openmobster@gmail.com">openmobster@gmail.com</a>&gt;</code></div></div></div></div><div class="toc"><dl><dt><span class="sect1"><a href="pg_ios.html#d0e1983">13.1. Introduction</a></span></dt><dt><span class="sect1"><a href="pg_ios.html#d0e2000">13.2. Prepare the mobilecloudlib static library</a></span></dt><dt><span class="sect1"><a href="pg_ios.html#d0e2021">13.3. Start a Cordova-based App</a></span></dt><dt><span class="sect1"><a href="pg_ios.html#d0e2033">13.4. Copy JSON components to the App</a></span></dt><dt><span class="sect1"><a href="pg_ios.html#d0e2049">13.5. Create a Group called OpenMobster</a></span></dt><dt><span class="sect1"><a href="pg_ios.html#d0e2070">13.6. Add the libraries and Frameworks</a></span></dt><dt><span class="sect1"><a href="pg_ios.html#d0e2087">13.7. Add OpenMobster bootstrap code</a></span></dt><dd><dl><dt><span class="sect2"><a href="pg_ios.html#d0e2092">13.7.1. The bootstrapping functions</a></span></dt><dt><span class="sect2"><a href="pg_ios.html#d0e2127">13.7.2. Integrating the bootstrapping function with the App Delegate</a></span></dt></dl></dd><dt><span class="sect1"><a href="pg_ios.html#d0e2154">13.8. PhoneGapSync App</a></span></dt></dl></div><div class="sect1" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e1983"/>13.1. Introduction</h2></div></div></div><p>
   		 	<a class="ulink" href="http://www.phonegap.com">PhoneGap</a> is an HTML5 app platform that allows you to author native applications with web technologies and get access to APIs and app stores. <span class="bold"><strong>PhoneGap</strong></span> leverages web technologies developers already know best... HTML and JavaScript.
   		 	Starting with <span class="bold"><strong>OpenMobster 2.2-M8</strong></span>, you can write offline web apps with synchronization of data using the <span class="bold"><strong>OpenMobster Sync Plugin</strong></span> for PhoneGap. The Sync Plugin exposes the native Sync service to the
   		 	JavaScript layer using the PhoneGap bridge technology. The rest of this chapter will discuss how to setup an iOS app for development using the SyncPlugin for iOS.
   		</p></div><div class="sect1" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e2000"/>13.2. Prepare the <span class="bold"><strong>mobilecloudlib</strong></span> static library</h2></div></div></div><p>
   			</p><div class="itemizedlist"><ul><li>Open the mobilecloudlib XCode project by opening: <span class="bold"><strong>iPhone/mobilecloudlib/mobilecloudlib.xcodeproj</strong></span></li><li>Build the project in XCode</li></ul></div><p>
   		</p><p>
   			For some reason, building the mobilecloudlib fail to compile if your XCode code location is set to the recommended setting of "Derived Data". You must change this option to "Location Specified By Targets".
			Please take a look at this thread for details: <a class="ulink" href="https://groups.google.com/forum/#!searchin/openmobster-users/mobilecloudlib/openmobster-users/zJhJKbFekLs/WiNWtKfG_RcJ">https://groups.google.com/forum/#!searchin/openmobster-users/mobilecloudlib/openmobster-users/zJhJKbFekLs/WiNWtKfG_RcJ</a>
   		</p></div><div class="sect1" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e2021"/>13.3. Start a Cordova-based App</h2></div></div></div><p>
   			</p><div class="itemizedlist"><ul><li>Go to File&gt;New Project. In the displayed project templates select the <span class="bold"><strong>Cordova-based Application</strong></span> and follow the wizard</li></ul></div><p>
   		</p></div><div class="sect1" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e2033"/>13.4. Copy JSON components to the App</h2></div></div></div><p>
   			</p><div class="itemizedlist"><ul><li>
   					Create a New Folder called <span class="bold"><strong>JSON</strong></span></li><li>
   					Go to the <span class="bold"><strong>mobilecloudlib</strong></span> project and Drag n Drop/Copy all the .h and .m files in the JSON folder to the JSON folder in your PhoneGap app
   				</li></ul></div><p>
   		</p></div><div class="sect1" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e2049"/>13.5. Create a Group called <span class="bold"><strong>OpenMobster</strong></span></h2></div></div></div><p>
   			</p><div class="itemizedlist"><ul><li>Create a New group named <span class="bold"><strong>OpenMobster</strong></span></li><li>From the <span class="bold"><strong>mobilecloudlib</strong></span>project, DragnDrop/Copy all the resources located under the <span class="bold"><strong>app-bundle</strong></span> group</li></ul></div><p>
   		</p></div><div class="sect1" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e2070"/>13.6. Add the libraries and Frameworks</h2></div></div></div><p>
   			In the Frameworks group add the following library and Frameworks
   			</p><div class="itemizedlist"><ul><li>libmobilecloudlib.a - OpenMobster static library</li><li>CoreData.framework</li><li>CFNetwork.framework</li><li>CoreGraphics.framework</li><li>UIKit.framework</li></ul></div><p>
   		</p></div><div class="sect1" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e2087"/>13.7. Add OpenMobster bootstrap code</h2></div></div></div><p>
   			Before OpenMobster runtime can be used within an App. It must be bootstrapped and started. The following code shows how this bootstrapping process works.
   		</p><div class="sect2" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e2092"/>13.7.1. The bootstrapping functions</h3></div></div></div><div class="sect3" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e2095"/>13.7.1.1. Start Cloud Service</h4></div></div></div><p>
   					</p><pre class="programlisting">
   						
-(void)startCloudService
{
	@try 
	{
		CloudService *cloudService = [CloudService getInstance];
		[cloudService startup];
	}
	@catch (NSException * e) 
	{
		//something caused the kernel to crash
		//stop the kernel
		[self stopCloudService];
	}
}
   						
   					</pre><p>
   				</p></div><div class="sect3" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e2103"/>13.7.1.2. Stop Cloud Service</h4></div></div></div><p>
   					</p><pre class="programlisting">
   						
-(void)stopCloudService
{
	@try
	{
		CloudService *cloudService = [CloudService getInstance];
		[cloudService shutdown];
	}
	@catch (NSException *e) 
	{
		
	}
}
   						
   					</pre><p>
   				</p></div><div class="sect3" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e2111"/>13.7.1.3. Start Device Activation if it is not activated with the Cloud already</h4></div></div></div><p>
   					</p><pre class="programlisting">
   						
-(void)startActivation
{
	@try 
	{
		CloudService *cloudService = [CloudService getInstance];
		[cloudService forceActivation:self.viewController];
	}
	@catch (NSException * e) 
	{
		//something caused the kernel to crash
		//stop the kernel
		[self stopCloudService];
	}
}
   						
   					</pre><p>
   				</p></div><div class="sect3" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e2119"/>13.7.1.4. Do a Sync at Startup</h4></div></div></div><p>
   					</p><pre class="programlisting">
   						
-(void)sync
{
    CommandContext *commandContext = [CommandContext withInit:self.viewController];
    BackgroundSyncCommand *syncCommand = [BackgroundSyncCommand withInit];
    [commandContext setTarget:syncCommand];
    CommandService *service = [CommandService getInstance];
    [service execute:commandContext]; 
}
   						
   					</pre><p>
   				</p></div></div><div class="sect2" lang="en-US"><div class="titlepage"><div><div><h3 class="title"><a id="d0e2127"/>13.7.2. Integrating the bootstrapping function with the App Delegate</h3></div></div></div><div class="sect3" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e2130"/>13.7.2.1. - (BOOL) application:(UIApplication*)application didFinishLaunchingWithOptions:(NSDictionary*)launchOptions</h4></div></div></div><p>
   				</p><pre class="programlisting">
   						
- (BOOL) application:(UIApplication*)application didFinishLaunchingWithOptions:(NSDictionary*)launchOptions
{
    //OpenMobster bootstrapping
    [self startCloudService];
    [self sync];
    
    NSURL* url = [launchOptions objectForKey:UIApplicationLaunchOptionsURLKey];
    if (url &amp;&amp; [url isKindOfClass:[NSURL class]]) {
        self.invokeString = [url absoluteString];
		NSLog(@"PhoneGapSyncApp launchOptions = %@", url);
    }    
    
    CGRect screenBounds = [[UIScreen mainScreen] bounds];
    self.window = [[[UIWindow alloc] initWithFrame:screenBounds] autorelease];
    self.window.autoresizesSubviews = YES;
    
    CGRect viewBounds = [[UIScreen mainScreen] applicationFrame];
    
    self.viewController = [[[MainViewController alloc] init] autorelease];
    self.viewController.useSplashScreen = YES;
    self.viewController.wwwFolderName = @"www";
    self.viewController.startPage = @"index.html";
    self.viewController.view.frame = viewBounds;
    
    // over-ride delegates
    self.viewController.webView.delegate = self;
    self.viewController.commandDelegate = self;

    // check whether the current orientation is supported: if it is, keep it, rather than forcing a rotation
    BOOL forceStartupRotation = YES;
    UIDeviceOrientation curDevOrientation = [[UIDevice currentDevice] orientation];
    
    if (UIDeviceOrientationUnknown == curDevOrientation) {
        // UIDevice isn't firing orientation notifications yet… go look at the status bar
        curDevOrientation = (UIDeviceOrientation)[[UIApplication sharedApplication] statusBarOrientation];
    }
    
    if (UIDeviceOrientationIsValidInterfaceOrientation(curDevOrientation)) {
        for (NSNumber *orient in self.viewController.supportedOrientations) {
            if ([orient intValue] == curDevOrientation) {
                forceStartupRotation = NO;
                break;
            }
        }
    } 
    
    if (forceStartupRotation) {
        NSLog(@"supportedOrientations: %@", self.viewController.supportedOrientations);
        // The first item in the supportedOrientations array is the start orientation (guaranteed to be at least Portrait)
        UIInterfaceOrientation newOrient = [[self.viewController.supportedOrientations objectAtIndex:0] intValue];
        NSLog(@"AppDelegate forcing status bar to: %d from: %d", newOrient, curDevOrientation);
        [[UIApplication sharedApplication] setStatusBarOrientation:newOrient];
    }
    
    
    [self.window addSubview:self.viewController.view];
    [self.window makeKeyAndVisible];
    
    //OpenMobster bootstrapping
    [self startActivation];
    
    return YES;
}
   						
   					</pre><p>
   				</p></div><div class="sect3" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e2138"/>13.7.2.2. -(void)applicationWillEnterForeground:(UIApplication *)application</h4></div></div></div><p>
   					</p><pre class="programlisting">
   						
-(void)applicationWillEnterForeground:(UIApplication *)application 
{
    /*
     Called as part of  transition from the background to the inactive state: here you can undo many of the changes made on entering the background.
     */
	[self sync];
}
   						
   						
   					</pre><p>
   				</p></div><div class="sect3" lang="en-US"><div class="titlepage"><div><div><h4 class="title"><a id="d0e2146"/>13.7.2.3. -(void)applicationWillTerminate:(UIApplication *)application</h4></div></div></div><p>
   					</p><pre class="programlisting">
   						
-(void)applicationWillTerminate:(UIApplication *)application 
{
    /*
     Called when the application is about to terminate.
     See also applicationDidEnterBackground:.
     */
	[self stopCloudService];
}
   						
   					</pre><p>
   				</p></div></div></div><div class="sect1" lang="en-US"><div class="titlepage"><div><div><h2 class="title"><a id="d0e2154"/>13.8. PhoneGapSync App</h2></div></div></div><p>
   		In the OpenMobster distribution, you can find an iOS/PhoneGap Sync App under <span class="bold"><strong>iphone/PhoneGapSyncApp</strong></span>.
   		On the Cloud Side, the App to run is located under <span class="bold"><strong>iphone/showcase/cloud</strong></span>. You run the Cloud Server using the command
   		</p><pre class="programlisting">
   		
   			mvn -PrunCloud integration-test
   		
   		</pre><p>
   		</p></div></div><ul class="docnav"><li class="previous"><a accesskey="p" href="pg_sample.html"><strong>Prev</strong>Chapter 12. PhoneGap: Offline Web Apps using the ...</a></li><li class="up"><a accesskey="u" href="#"><strong>Top of page</strong></a></li><li class="home"><a accesskey="h" href="index.html"><strong>Front page</strong></a></li><li class="next"><a accesskey="n" href="pg_reference.html"><strong>Next</strong>Chapter 14. PhoneGap: Sync Plugin Reference</a></li></ul></body></html>